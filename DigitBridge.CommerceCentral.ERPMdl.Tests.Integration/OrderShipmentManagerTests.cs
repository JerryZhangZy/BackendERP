


//-------------------------------------------------------------------------
// This document is generated by T4
// It will overwrite your changes, please keep it as it is
// <copyright company="DigitBridge">
//     Copyright (c) DigitBridge Inc.  All rights reserved.
// </copyright>
//-------------------------------------------------------------------------
using System;
using System.Collections.Generic;
using System.Linq;
using System.Runtime.CompilerServices;
using System.Text;
using System.Threading.Tasks;
using Microsoft.Extensions.Configuration;
using Xunit;
using DigitBridge.CommerceCentral.YoPoco;
using DigitBridge.Base.Utility;
using DigitBridge.CommerceCentral.XUnit.Common;
using DigitBridge.CommerceCentral.ERPDb;
using Bogus;
using DigitBridge.CommerceCentral.ERPDb.Tests.Integration;

namespace DigitBridge.CommerceCentral.ERPMdl.Tests.Integration
{
    public partial class OrderShipmentManagerTests
    {
        #region get faker data
        public const int MasterAccountNum = 10001;
        public const int ProfileNum = 10001; 
        protected Inventory[] GetInventories(int count = 10)
        {
            return InventoryDataTests.GetInventories(DataBaseFactory, count);
        }
        protected OrderShipmentDataDto GetFakerDataDto(Inventory[] inventories = null)
        {
            var data = OrderShipmentDataTests.GetFakerData_SkuInDB(DataBaseFactory, inventories); 
            data.OrderShipmentHeader.OrderDCAssignmentNum = new Random().Next(1, 100000);


            var mapper = new OrderShipmentDataDtoMapperDefault();
            return mapper.WriteDto(data, null);
        }

        protected SalesOrderDataDto GetFakerSalesorderDataDto(OrderShipmentData shipmentData, Inventory[] inventories)
        {
            var data = SalesOrderDataTests.GetFakerData();
            data.SalesOrderHeader.OrderSourceCode = $"OrderDCAssignmentNum:{shipmentData.OrderShipmentHeader.OrderDCAssignmentNum}";
            for (int i = 0; i < data.SalesOrderItems.Count; i++)
            {
                var item = data.SalesOrderItems[i];

                item.DiscountAmount = 0;
                item.ShipQty = new Random().Next(10, 100);//TOdo set to shipment shipqty

                var inventory = inventories[i];
                item.WarehouseCode = inventory.WarehouseCode;
                item.WarehouseUuid = inventory.WarehouseUuid;
                item.SKU = inventory.SKU;
                item.InventoryUuid = inventory.InventoryUuid;
                item.ProductUuid = inventory.ProductUuid;
            }
            data.SalesOrderHeader.OrderNumber = NumberGenerate.Generate();
            var mapper = new SalesOrderDataDtoMapperDefault();
            return mapper.WriteDto(data, null);
        }

        #endregion

        [Fact()]
        //[Fact(Skip = SkipReason)]
        public async Task CreateShipmentFromPayloadAsync_Test()
        {
            var srv = new OrderShipmentManager(DataBaseFactory);
            var dto = GetFakerDataDto();
            var payload = new OrderShipmentPayload()
            {
                MasterAccountNum = MasterAccountNum,
                ProfileNum = ProfileNum,
                OrderShipment = dto,
            };
            (var success, string shipmentUuid) = await srv.CreateShipmentFromPayloadAsync(payload);

            Assert.True(success, srv.Messages.ObjectToString());
            Assert.False(string.IsNullOrEmpty(shipmentUuid));
        }

        [Fact()]
        //[Fact(Skip = SkipReason)]
        public async Task CreateInvoiceByOrderShipmentIdAsync_Test()
        {
            var skus = GetInventories();

            var srv = new OrderShipmentService(DataBaseFactory);
            var shipmentDto = GetFakerDataDto(skus);
            var success = await srv.AddAsync(shipmentDto);
            Assert.True(success && srv.Data.OrderShipmentHeader.OrderShipmentNum > 0, srv.Messages.ObjectToString());

            var salesorderService = new SalesOrderService(DataBaseFactory);
            var salesorderDataDto = GetFakerSalesorderDataDto(srv.Data, skus);
            success = await salesorderService.AddAsync(salesorderDataDto);
            Assert.True(success, salesorderService.Messages.ObjectToString());

            var managerService = new OrderShipmentManager(DataBaseFactory);
            (var result, var invoiceuuid) = await managerService.CreateInvoiceByOrderShipmentIdAsync(srv.Data.UniqueId);
            Assert.True(result, managerService.Messages.ObjectToString());
            Assert.False(string.IsNullOrEmpty(invoiceuuid));
        }
    }
}



