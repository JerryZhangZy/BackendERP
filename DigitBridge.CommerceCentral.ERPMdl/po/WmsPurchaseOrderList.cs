//-------------------------------------------------------------------------
// This document is generated by T4
// It will overwrite your changes, please keep it as it is
// <copyright company="DigitBridge">
//     Copyright (c) DigitBridge Inc.  All rights reserved.
// </copyright>
//-------------------------------------------------------------------------
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using DigitBridge.Base.Common;
using DigitBridge.Base.Utility;
using DigitBridge.CommerceCentral.ERPDb;
using DigitBridge.CommerceCentral.YoPoco;
using Microsoft.Data.SqlClient;

namespace DigitBridge.CommerceCentral.ERPMdl
{
    public class WmsPurchaseOrderList : SqlQueryBuilder<WmsPurchaseOrderQuery>
    {
        public WmsPurchaseOrderList(IDataBaseFactory dbFactory) : base(dbFactory)
        {
        }
        public WmsPurchaseOrderList(IDataBaseFactory dbFactory, WmsPurchaseOrderQuery queryObject)
            : base(dbFactory, queryObject)
        {
        }

        #region override methods

        protected override string GetSQL_select()
        {
            this.SQL_Select = $@"
select 
pohi.DistributionCenterNum as CentralPoNum,poh.DatabaseNum as CentralDatabaseNum,poh.PoUuid as PoUuid,poh.PoNum as PoNumber,poh.VendorName,poh.PoDate,poh.CancelDate as CancelAfterDate,dc.DistributionCenterCode as WarehousCode,
(select poit.PoUuid as PoUuid,poit.PoItemUuid as PoItemUuid,poit.SKU,poit.Price as PoPrice,CAST(poit.PoQty as INT) AS PoQty,poit.EtaShipDate,poit.Seq as Sequence,poit.PoItemUuid as OriginaLineId,poit.EnterDateUtc as EnterDate 
from PoItems poit 
WHERE poh.PoUuid=poit.PoUuid  FOR JSON PATH ) AS PoLineList
";
            return this.SQL_Select;
        }

        protected override string GetSQL_from()
        {
            this.SQL_From = $@"
from PoHeader poh 
left join PoHeaderInfo pohi on poh.PoUuid=pohi.PoUuid 
left join DistributionCenter dc on pohi.WarehouseUuid=dc.DistributionCenterUuid
";
            return this.SQL_From;
        }

        #endregion override methods

        public virtual void GetPurchaseOrderList(PurchaseOrderPayload payload)
        {
            if (payload == null)
                payload = new PurchaseOrderPayload();

            this.LoadRequestParameter(payload);
            StringBuilder sb = new StringBuilder();
            try
            {
                payload.PurchaseOrderListCount = Count();
                payload.Success = ExcuteJson(sb);
                if (payload.Success)
                    payload.PurchaseOrderList = sb;
            }
            catch (Exception ex)
            {
                payload.PurchaseOrderListCount = 0;
                payload.PurchaseOrderList = null;
                AddError(ex.ObjectToString());
                payload.Success = false;
                payload.Messages = this.Messages;
            }
        }

        public virtual async Task GetPurchaseOrderListAsync(PurchaseOrderPayload payload)
        {
            if (payload == null)
                payload = new PurchaseOrderPayload();

            this.LoadRequestParameter(payload);
            StringBuilder sb = new StringBuilder();
            try
            {
                payload.PurchaseOrderListCount = await CountAsync();
                payload.Success = await ExcuteJsonAsync(sb);
                if (payload.Success)
                    payload.PurchaseOrderList = sb;
            }
            catch (Exception ex)
            {
                payload.PurchaseOrderListCount = 0;
                payload.PurchaseOrderList = null;
                AddError(ex.ObjectToString());
                payload.Success = false;
                payload.Messages = this.Messages;
            }
        }

    }
}
